{{- $codespaces := env "CODESPACES" | not | not -}}
{{- $gitpod := env "GITPOD_WORKSPACE_ID" | not | not -}}
{{- $wsl := (and (eq .chezmoi.os "linux") (.chezmoi.kernel.osrelease | lower | contains "microsoft")) -}}

{{- $opAvailable := env "OP_ENABLED" | not | not -}}
{{- $opEnabled := env "OP_SESSION_F3TE4WF6SFE2PCZDHWTDWB2GA4" | not | not -}}

{{- $distro := (.chezmoi.os) -}}
{{- $distroLike := (.chezmoi.os) -}}

{{- if (eq $distro "linux") -}}
{{- $distro = (.chezmoi.osRelease.id) -}}
{{- $distroLike = (.chezmoi.osRelease.idLike) -}}
{{- end -}}

{{- $chassisType := "desktop" -}}
{{- if (or $codespaces $gitpod) -}}
{{-   $chassisType = "ephemeral" -}}
{{- else if stat "/home/kasm-default-profile" -}}
{{-   $chassisType = "kasm" -}}
{{- else if $wsl }}
{{-   $chassisType = "wsl" -}}
{{- else if eq .chezmoi.os "darwin" -}}
{{-   if contains "MacBook" (output "sysctl" "-n" "hw.model") -}}
{{-     $chassisType = "laptop" -}}
{{-   else -}}
{{-     $chassisType = "desktop" -}}
{{-   end -}}
{{- else if eq .chezmoi.os "linux" -}}
{{-   $chassisType = (output "hostnamectl" "--json=short" | mustFromJson).Chassis -}}
{{- else if eq .chezmoi.os "windows" -}}
{{-   $chassisType = (output "powershell.exe" "-noprofile" "-command" "if (Get-WmiObject -Class win32_battery -ComputerName localhost) { echo laptop } else { echo desktop }") -}}
{{- end -}}

{{ $pokemon := false }}
{{ $email := "hey@vlad.gg" }}
{{- if (regexMatch "Mac-[A-Za-z0-9]+" .chezmoi.hostname) -}}
{{ $pokemon := true }}
{{ $email := "v.zaharia@pokemon.com" }}
{{- end -}}

sourceDir = {{ .chezmoi.sourceDir | quote }}

[data]
    chezmoi.chassis = {{ $chassisType | quote }}
    chezmoi.distro.name = {{ $distro | quote }}
    chezmoi.distro.like = {{ $distroLike | quote }}

    flags.op.available = {{ $opAvailable }}
    flags.op.enabled = {{ (and (or $opAvailable $opEnabled) (not $pokemon)) }}
    flags.pokemon = {{ $pokemon }}

    personal.name = "Vlad Zaharia"
    personal.email = {{ $email | quote }}